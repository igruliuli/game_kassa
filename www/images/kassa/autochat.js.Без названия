(function(n){var t=n.p3chat._p3,e=t.dbg.log,r=null,o=t.Promise,i=t.asEventful,a=t.t,u=n.location,l=7200,c=1800,s=u.pathname+u.search,f=n.document.title;t.Autochat=function(n){function e(n){m("match")&&N.fulfill(n)}function h(n,t){return E=n||E,w=t||w,M.check()&&x.fulfill(),I.prolong(E),b}function v(n,t){function e(n){"match"===o&&N.then(n),"stop"===o&&P.then(n),"page"===o&&I.on("page",function(t,e,r,o){n.apply(b,[e,r,o,u.host+E,w])},!0),"progress"===o&&_.on("progress",function(t){var e=[].slice.call(arguments,1),r=t.split(".")[1];n.apply(b,[r].concat(e))},!0),"expire"===o&&I.on("expire",function(){n.apply(b)},!0)}var r={};"string"===a(n)?r[n]=t:r=n;for(var o in r)r.hasOwnProperty(o)&&e(r[o]);return b}function m(n){return P.fulfill(n)&&M.lock()}function y(){r&&r.clear(),u.reload()}var b={},_=i({});r=t.store;for(var E=s,w=f,k=n.rules,C=n.session_time=n.session_time||c,j=n.lock_time=n.lock_time||l,I=d(C),M=g(j),L=function(n,t){function e(t){return"regexp"===n.match?-1!==t.search(RegExp(n.url,"i")):"head"===n.match?0===t.indexOf(n.url):"exact"===n.match?t===n.url:void 0}e(E)&&t()},S=function(n,t){var e=10,r={time:function(n){var e="progress."+n.id,r=null;I.on("page",function(o,i,a,u){r&&r.reset(!0),r=p(n.delay-u).on("tick",function(t,r){var o=n.delay?Math.floor(100*((u+r)/n.delay)+.5):100;_.trigger(e,[o])}).on("done",function(){t(n.id)}).reset()},!0)},"url-match":function(n){var r="progress."+n.id;I.on("page",function(){L(n,function(){p(n.delay).on("tick",function(t,o){var i=n.delay?Math.floor(e*o/n.delay+.5):e;_.trigger(r,[90+i])}).on("done",function(){t(n.id)}).reset()})},!0)},"page-count":function(n){var r,o="progress."+n.id;I.on("page",function(i,a,u){var l=u/n.pageCount,c=(100-e)*Math.min(l,1),s=Math.floor(c+.5);1>l&&_.trigger(o,[s]),l>=1&&(r&&r.reset(!0),r=p(n.delay).on("tick",function(t,r){var i=n.delay?Math.floor(e*r/n.delay+.5):e;_.trigger(o,[s+i])}).on("done",function(){t(n.id)}).reset())},!0)}};r[n.type](n)},B=function(n){for(var t=0;k.length>t;t++){var e=k[t];S(e,n)}},A=0;k.length>A;A++){var O=k[A];O.type=O.hasOwnProperty("match")?"url-match":O.hasOwnProperty("pageCount")?"page-count":"time","url-match"===O.type&&/(head|exact)/.test(O.match)&&(O.url=O.url.replace(/^.*?\/\//,"").replace(/^[^\/]*/,""))}var P=o(function(n){k.length||n.fulfill("no rules"),M.on("lock",function(t,e){n.fulfill("locked for "+e)})}).then(),x=o(),N=o(function(){x.then(function(){B(e)})});return b.settings=n,b.track=h,b.on=v,b.stop=m,b.restart=y,b};var d=function(n){function t(t){var e=+new Date,i=parseInt(r.get("p3chat-pvisits")||0,10),l=parseInt(r.get("p3chat-ptime")||e,10),c=parseInt(r.get("p3chat-psec")||0,10),s=(e-l)/1e3,f=s>n,d=u.count(t,f),p=f?0:Math.floor(c+s+.5);r.set("p3chat-psec",p),r.set("p3chat-ptime",e),p||(i++,r.set("p3chat-pvisits",i)),a.reset(),o.trigger("page",[i,d,p])}function e(){r.set("p3chat-ptime",0),r.set("p3chat-psec",0),o.trigger("expire")}var o=i({}),a=p(n).on("done",e),u=h();return o.prolong=t,o},p=function(n,t){function e(t){var e=+new Date;return a&&clearInterval(a),t?r:(a=setInterval(function(){var t=Math.floor((+new Date-e)/1e3+.5);r.trigger("tick."+a,[t]),t>=n&&(clearInterval(a),r.trigger("done."+a,[t]))},o),r)}var r=i({}),o=1e3*Math.min(n,t||1),a=null;return r.reset=e,r},h=function(){function n(){return a.length}function t(t,o){if(r){var i=r.get("p3chat-ppages"),u=!0;o?a=[]:i&&(a=i.split(/>/),t===a[a.length-1]&&(u=!1)),u&&(a.push(t),r.set("p3chat-ppages",a.join(">")))}return e("Pages _tracked: "+n()),n()}var o=i({}),a=[];return o.count=t,o},g=function(n){function t(){if(r){var t=+new Date,e=r.get("p3chat-plocked");if(e)if(1e3*n>t-e){a=!0;var i=Math.floor(n-(t-e)/1e3+.5);o.trigger("lock",[i])}else a=!1,r.set("p3chat-plocked","")}return!a}function e(){return a?!1:(a=!0,r&&r.set("p3chat-plocked",+new Date),!0)}var o=i({}),a=!1;return o.check=t,o.lock=e,o}})(window);